#compdef killport

local -a matches
local pid="" cmd=""

while IFS= read -r line; do
  case $line in
    p*) pid=${line#p} ;;
    c*) cmd=${line#c} ;;
    n*)
      local addr=${line#n}
      if [[ $addr == *:* ]]; then
        local port=${${addr%%->*}##*:}
        [[ $port == <-> ]] && matches+=("${port}:${cmd} (PID ${pid})")
      fi
      ;;
  esac
done < <(lsof -i -P -n -F pcn 2>/dev/null)

typeset -U matches
_describe -t ports 'port' matches
